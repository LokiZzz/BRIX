@page "/npc/{Id:guid}"
@page "/summon/{Id:guid}"

@if (NPC is null)
{
    return;
}

<FooterBox>
    <Content>
        <div class="box block">
            <Field @bind-Value="NPC.Name"
                    Label="@Localization[Resource.Common_Name]"
                    @bind-Value:after="@(() => npcChanged = true)" />
            <TextAreaField @bind-Value="NPC.Description"
                            MaxLength="500"
                            Label="@Localization[Resource.Common_Description]"
                            @bind-Value:after="@(() => npcChanged = true)" />
            <Field @bind-Value="NPC.SetHealth"
                    Label="@Localization[Resource.NPC_Health]"
                    @bind-Value:after="@(() => npcChanged = true)" />
        </div>

        <button class="button is-large is-fullwidth block" @onclick="AddAbility">
            <i class="fa fa-plus-circle"></i>
        </button>

        @foreach (Ability ability in NPC.Abilities)
        {
            <div class="box block">
                <p class="title">@ability.Name</p>
                <p class="subtitle">@ability.ExpCost() EXP</p>
                <div class="buttons">
                    <button class="button" @onclick="@(() => EditAbility(ability))">
                        @Localization[nameof(Resource.Common_Edit)]
                    </button>
                    <button class="button is-danger" @onclick="@(() => RemoveAbility(ability))">
                        @Localization[nameof(Resource.Common_Remove)]
                    </button>
                </div>
            </div>
        }
    </Content>
    <Footer>
        <div class="is-flex is-flex-direction-row is-justify-content-space-between">
            <p class="title">@Localization[nameof(Resource.Common_Power)]</p>
            <p class="title">@NPC.Power EXP</p>
        </div>
        @if (npcChanged)
        {
            <div class="buttons is-flex is-justify-content-flex-end">
                <button class="button" @onclick="ResetAsync">@Localization[nameof(Resource.Common_Reset)]</button>
                <button class="button is-primary" @onclick="SaveAsync">@Localization[nameof(Resource.Common_Save)]</button>
            </div>
        }
    </Footer>
</FooterBox>

@code {
    [Parameter]
    public Guid Id { get; set; }

    [Parameter]
    [SupplyParameterFromQuery]
    public Guid CharacterId { get; set; }

    private NPC NPC { get; set; } = default!;
    private bool npcChanged = false;
    private ENPCPageMode mode = ENPCPageMode.NPC;

    protected override async Task OnInitializedAsync()
    {
        mode = GetMode();
        NPC? npc = NPCManager.EditingNPC;

        if (npc is null)
        {
            if (mode == ENPCPageMode.NPC)
            {
                npc = await NPCManager.GetAsync(Id);
                NPCManager.EditNPC(npc);
            }
            else if (mode == ENPCPageMode.Summon)
            {
                // Теоретически сюда переходят из эффекта призыва и NPC должен быть уже на редактировании
                // эта инициализация здесь на всякий случай, если вдруг сюда с нуля переходят, например из закладок
                CharacterManager.EditCharacter(
                    await CharacterManager.GetAsync(CharacterId)
                );

                NPCManager.EditNPC(
                    new SummoningParameters()
                    {
                        EditingCharacter = CharacterManager.EditingCharacter
                            ?? throw new Exception("Editing character not found."),
                        CreatureId = Id,
                    }
                );
            }
        }

        if (npc is not null)
        {
            NPC = npc;
        }
        else
        {
            Navigation.NavigateTo("/404");
        }
    }

    private async Task AddAbility(MouseEventArgs e)
    {
        await SaveAsync();
        Navigation.NavigateToRelative($"/abilities/new");
    }

    private async Task EditAbility(Ability ability)
    {
        await SaveAsync();
        int abilityNumber = NPC.Abilities.IndexOf(ability);
        Navigation.NavigateToRelative($"/abilities/{abilityNumber}");
    }

    private async Task RemoveAbility(Ability ability)
    {
        NPC.RemoveAbility(ability);
        await NPCManager.SaveAsync(NPC);
    }

    private async Task SaveAsync()
    {
        await NPCManager.SaveAsync(NPC);
        npcChanged = false;
    }

    private async Task ResetAsync()
    {
        await OnInitializedAsync();
        npcChanged = false;
    }

    private ENPCPageMode GetMode()
    {
        return Navigation.Uri.Contains("npc") ? ENPCPageMode.NPC : ENPCPageMode.Summon;
    }

    private enum ENPCPageMode
    {
        NPC = 0,
        Summon = 1
    }
}
