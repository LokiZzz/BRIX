@inherits EffectPageBase<SummonCreatureEffect>

@page "/{OwnerType}/{OwnerId:guid}/abilities/{AbilityNumber:int}/effects/smn/{EffectOrderNumber:int}"

@if (Effect is null)
{
    return;
}

<div class="box">
    <p class="title">@Localization[nameof(Resource.Effect_SummonCreatureEffect)]</p>
    <p class="block">@Localization[nameof(Resource.Effect_SummonCreatureEffect_Hint)]</p>
</div>


<div class="buttons">
    <button class="button is-large block" @onclick="AddCreature">
        <i class="fa fa-plus-circle"></i>
    </button>
    <button class="button is-large block">
        Скопировать существующего
    </button>
</div>


@if (Effect.Creatures.Count > 0)
{
    foreach (CreaturesGroup creatureGroup in Effect.Creatures)
    {
        <div class="box">
            <p class="title">@creatureGroup.Creature.Name (x @creatureGroup.Count)</p>
            <p class="block">@Localization[nameof(Resource.Common_Power)]: @creatureGroup.Creature.Power</p>
            <button class="button" @onclick="() => EditCreature(creatureGroup)">
                @Localization[nameof(Resource.Common_Edit)]
            </button>
            <button class="button" @onclick="() => RemoveCreature(creatureGroup)">
                @Localization[nameof(Resource.Common_Remove)]
            </button>
        </div>
    }
}

<AspectsPanel Aspects="Effect.Aspects" />

@code
{
    private void AddCreature()
    {
        CreaturesGroup newCreatureGroup = new();
        int number = (Effect?.Creatures.Count ?? 0) + 1;
        newCreatureGroup.Count = 1;
        newCreatureGroup.Creature.Name = $"{Localization[Resource.Effect_SummonCreatureEffect_New]} {number}";
        Effect?.Creatures.Add(newCreatureGroup);
        Layout.Refresh();
    }

    private void EditCreature(CreaturesGroup creatureGroup)
    {
        NPCManager.EditNPC(
            new SummonDescriptor()
            {
                EditingCharacter = CharacterManager.EditingCharacter
                    ?? throw new Exception("Editing character not found."),
                CreatureId = creatureGroup.Creature.Id,
            }
        );

        Navigation.NavigateTo($"/summon/{creatureGroup.Creature.Id}?chr={CharacterManager.EditingCharacter.Id}");
    }

    private void RemoveCreature(CreaturesGroup creatureGroup)
    {
        Effect?.Creatures.Remove(creatureGroup);
        Layout.Refresh();
    }
}